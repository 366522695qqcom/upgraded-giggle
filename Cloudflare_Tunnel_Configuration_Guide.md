# Cloudflare Tunnel 配置指南

## 1. 问题概述

本指南针对 OpenFrontIO 应用中出现的 Cloudflare API 401 认证错误（错误代码 10000）提供永久解决方案。我们已经实现了代码级别的优化，现在您可以选择以下两种模式运行应用：

### 模式 1: 跳过 Cloudflare 隧道（临时解决方案）

当您在 Zeabur 等平台部署应用，且暂时不想配置 Cloudflare 时，可以设置：

- `CF_ACCOUNT_ID=skip-tunnel`
- `CF_API_TOKEN=skip-tunnel`

### 模式 2: 正确配置 Cloudflare 凭证（永久解决方案）

按照本指南创建有效的 Cloudflare API 令牌，确保应用正常工作。

## 2. Cloudflare API 令牌创建步骤

### 2.1 登录 Cloudflare 账户

1. 访问 [Cloudflare 官方网站](https://dash.cloudflare.com/)
2. 使用您的凭据登录

### 2.2 导航到 API 令牌创建页面

1. 点击右上角的用户头像
2. 选择 "我的个人资料"
3. 在左侧菜单中选择 "API 令牌"
4. 点击 "创建令牌" 按钮

### 2.3 创建具有正确权限的令牌

1. 选择 "创建自定义令牌"
2. 在 "令牌名称" 字段中输入描述性名称（例如：`OpenFrontIO-Tunnel-Manager`）
3. 在权限部分，添加以下权限：
   - **Account** > **Cloudflare Tunnel:Edit** - 允许创建和管理隧道
   - **Zone** > **DNS:Edit** - 允许创建和更新 DNS 记录
   - **Zone** > **Zone:Read** - 允许读取区域信息

### 2.4 配置资源访问范围

1. 在 "Account Resources" 部分，选择：
   - "包括" > "特定账户" > 选择您的账户
2. 在 "Zone Resources" 部分，选择：
   - "包括" > "所有区域" 或选择您要使用的特定区域

### 2.5 完成创建

1. 向下滚动并点击 "继续创建令牌"
2. 点击 "创建令牌"
3. 复制生成的 API 令牌（请妥善保存，此令牌只会显示一次）

### 2.6 获取账户 ID

1. 返回 Cloudflare 仪表板
2. 点击左侧菜单中的 "Workers & Pages"
3. 在左侧菜单底部，您会看到 "账户 ID"
4. 点击旁边的复制按钮获取账户 ID

## 3. 配置应用环境变量

### 在 Zeabur 上配置

1. 登录 Zeabur 控制台
2. 进入您的项目设置
3. 找到环境变量配置部分
4. 设置以下环境变量：
   - `CF_ACCOUNT_ID`: 您的 Cloudflare 账户 ID
   - `CF_API_TOKEN`: 您新创建的 API 令牌
5. 保存更改并重新部署应用

### 本地开发配置

1. 在项目根目录创建或编辑 `.env` 文件
2. 添加以下行：
   ```
   CF_ACCOUNT_ID=您的账户ID
   CF_API_TOKEN=您的API令牌
   ```

## 4. 代码优化说明

我们已经在 `src/server/Server.ts` 文件中实现了智能检测逻辑：

1. **跳过隧道逻辑**: 如果 `CF_ACCOUNT_ID` 或 `CF_API_TOKEN` 设置为 "skip-tunnel"，应用将：

   - 跳过 Cloudflare 隧道创建
   - 记录明确的日志消息
   - 继续正常启动其他服务

2. **错误处理优化**: 应用现在会：
   - 在隧道创建前验证凭证
   - 提供更友好的错误信息
   - 避免因认证失败导致的无限重启循环

## 5. 故障排除

### 常见问题及解决方案

#### 问题 1: API 令牌权限不足

- **症状**: 收到 403 禁止访问错误
- **解决方案**: 确保 API 令牌具有上述所有必要权限

#### 问题 2: API 令牌过期

- **症状**: 认证突然失败
- **解决方案**: 检查令牌是否已过期，创建新的令牌

#### 问题 3: 账户 ID 错误

- **症状**: 收到账户不存在的错误
- **解决方案**: 确认您使用的是正确的账户 ID

## 6. 安全最佳实践

1. **令牌权限最小化**: 只授予应用所需的最小权限
2. **定期轮换令牌**: 建议每 90 天更新一次 API 令牌
3. **安全存储**: 永远不要将 API 令牌提交到版本控制系统
4. **监控使用**: 定期检查 API 令牌的使用情况，及时发现异常

## 7. 联系支持

如果您在配置过程中遇到任何问题，请联系技术支持团队获取帮助。

---

_本指南由 OpenFrontIO 技术团队编写，最后更新于 2023 年 10 月_
